var w=Object.defineProperty;var p=(l,e,t)=>e in l?w(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var a=(l,e,t)=>(p(l,typeof e!="symbol"?e+"":e,t),t);import{S as v,P as k,C as b,W as S,a as y,s as m,O as M,A as R,G as u,D as C,b as L,V as f,M as D,c as A,d as x,e as P,f as F,g as E,h as T,i as B}from"./vendor.a483fa53.js";const W=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}};W();class H{constructor(e){a(this,"el");a(this,"_boundHandleFrame");a(this,"startTime",-1);a(this,"glCanvas",document.createElement("canvas"));a(this,"glContext");a(this,"scene",new v);a(this,"camera",new k(60,window.innerWidth/window.innerHeight,1,1e3));a(this,"renderer");a(this,"effect");this.el=e,this._boundHandleFrame=this._handleFrame.bind(this),e.appendChild(this.glCanvas),this.glCanvas.id="threecanvas",this.scene.background=new b(13421772),this.camera.position.set(0,20,12),this.scene.add(this.camera);let t=this.glCanvas.getContext("webgl");if(!t)throw new Error("Cannot create WebGL render context in common.ts");this.glContext=t,this.renderer=new S({canvas:this.glCanvas,context:this.glContext,antialias:!0,alpha:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.glCanvas.offsetWidth,this.glCanvas.offsetHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=y,this.renderer.outputEncoding=m,this.effect=new M(this.renderer),this.camera.aspect=this.glCanvas.offsetWidth/this.glCanvas.offsetHeight,this.camera.updateProjectionMatrix();const s=new R(6710886,1);this.scene.add(s),this.initializeScene(),window.addEventListener("resize",i=>{this.camera.aspect=this.el.offsetWidth/this.el.offsetHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.el.offsetWidth,this.el.offsetHeight)}),window.requestAnimationFrame(this._boundHandleFrame)}static offset(e){e=e||window.event;var t=e.target||e.srcElement,s=t.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;return{x:i,y:n}}initializeScene(){}updateScene(e){}_handleFrame(e){window.requestAnimationFrame(this._boundHandleFrame),this.startTime==-1&&(this.startTime=e),this.updateScene(e),this.doRender()}doRender(){this.renderer.render(this.scene,this.camera)}}class O{constructor(){}getGallery(){const e=new u;e.name="environment";const t=new C;t.setDecoderPath("three/examples/js/libs/draco/gltf/");const s=new L;s.setDRACOLoader(t);var i=function(o){if(o.lengthComputable){var c=o.loaded/o.total*100;console.log(Math.round(c)+"% downloaded")}};return s.loadAsync("./assets/gallery/gallery.glb",i).then(function(o){const c=o.scene;c.name="gallery",c.receiveShadow=!0,c.traverse(function(d){d.isMesh&&(d.receiveShadow=!0)}),o.scene.traverse(d=>{d.material&&(d.material.metalness=0)}),c.scale.set(20,20,20),c.position.set(0,0,0),e.add(c)}),e}}const h=window.Ammo;let r;class G{constructor(e,t){a(this,"modelParams");a(this,"motionParams");a(this,"cameraParams");a(this,"poseParams");a(this,"miku");a(this,"helper");a(this,"loader");a(this,"scene");a(this,"camera");a(this,"mixer");a(this,"clips");a(this,"motionStatus",{inWalking:!1,inRunning:!1,inStartWalking:!1,inStartRunning:!1,inStopWalking:!1,inStopRunning:!1,inMovingForward:!1,inMovingBackward:!1,inRotatingLeft:!1,inRotatingRight:!1,direction:0,runFlag:!1,duration:0,elapsedTimeSinceStartWalking:0,elapsedTimeSinceStartRunning:0,elapsedTimeSinceStopWalking:0,elapsedTimeSinceStopRunning:0});a(this,"boneDictionary",{});a(this,"modelDictionary",{});a(this,"motionDictionary",{});a(this,"poses");a(this,"debug",!1);a(this,"ready",!1);a(this,"walkEnabled",!1);this.modelParams=[{name:"miku",file:"./assets/Yoimiya/Yoimiya.pmx",position:new f(30,0,0)}],this.motionParams=[{name:"walk",isMoving:!0,files:["./assets/vmd/walk/walk.vmd"]},{name:"run",isMoving:!0,files:["./assets/vmd/walk/run.vmd"]}],this.cameraParams=[{name:"camera",position:new f(0,0,-25)}],this.poseParams=[{name:"basic",file:"./assets/vpd/imas/makoto_basic.vpd"}],this.poses={},this.helper=new D({sync:!0,afterglow:0}),this.loader=new A,this.scene=e,this.camera=t,this.ready=!0,r=this,console.log("\u51C6\u5907\u597D\u4E86",this.ready)}getMixer(){return this.mixer}getMiku(){const e=new u;e.name="character";let t=this;this.loader.load(this.modelParams[0].file,function(s){t.mixer=new x(s),t.miku=s,t.miku.castShadow=!0,t.miku.traverse(function(i){i instanceof P&&i.material.forEach(n=>{n.map&&n.gradientMap&&(n.map.encoding=m,n.gradientMap.encoding=m,n.shininess=4)})}),console.log("model material:",t.miku.material),t.miku.scale.set(2,2,2),t.scene.add(t.miku),t.miku.position.add(t.modelParams[0].position),t.loader.loadAnimation(t.motionParams[0].files[0],t.miku,function(i){console.log(t.mixer);let n=[i];t.helper.add(t.miku,{animation:n,physics:!0});const o=t.mixer.clipAction(n[0]);t.motionDictionary.walk=o})},this.onProgress,this.onError),document.addEventListener("keydown",this.onKeydown,!1),document.addEventListener("keyup",this.onKeyup,!1)}actionDone(e){console.log("\u76D1\u542C\u52A8\u4F5C\u7ED3\u675F",e.target),r.mixer.removeEventListener("finished",r.actionDone),r.motionDictionary.walk.fadeOut(.5)}onKeydown(e){switch(e.key){case"Shift":r.motionStatus.runFlag=!0;break;case"ArrowLeft":r.motionStatus.inRotatingLeft=!0;break;case"ArrowUp":r.motionStatus.inMovingForward=!0;break;case"ArrowRight":r.motionStatus.inRotatingRight=!0;break;case"ArrowDown":r.motionStatus.inMovingBackward=!0;break}}onKeyup(e){switch(e.key){case"Shift":r.motionStatus.runFlag=!1;break;case"ArrowLeft":r.motionStatus.inRotatingLeft=!1;break;case"ArrowUp":r.motionStatus.inMovingForward=!1;break;case"ArrowRight":r.motionStatus.inRotatingRight=!1;break;case"ArrowDown":r.motionStatus.inMovingBackward=!1;break}}onProgress(e){if(e.lengthComputable){var t=e.loaded/e.total*100;console.log(Math.round(t)+"% downloaded")}}onError(e){console.log(e)}manageMove(e){let t=.3*e*60,s=this.motionStatus.inMovingForward||this.motionStatus.inMovingBackward,i=this.motionStatus.inRotatingLeft||this.motionStatus.inRotatingRight;if((this.motionStatus.inMovingForward||this.motionStatus.inMovingBackward||this.motionStatus.inRotatingLeft||this.motionStatus.inRotatingRight)&&this.motionStatus.runFlag,s){var o=t*Math.cos(this.motionStatus.direction),c=t*Math.sin(this.motionStatus.direction);this.motionStatus.inMovingForward&&(this.miku.position.z+=o,this.miku.position.x+=c),this.motionStatus.inMovingBackward&&(this.miku.position.z-=o,this.miku.position.x-=c)}if(i){var d=Math.PI*2/360*5*e*60;this.motionStatus.inRotatingLeft&&(this.motionStatus.direction+=d,this.miku.rotateY(d)),this.motionStatus.inRotatingRight&&(this.motionStatus.direction-=d,this.miku.rotateY(-d))}s&&!this.walkEnabled?(this.helper.enable("animation",!0),this.helper.enable("ik",!0),this.helper.enable("grant",!0),this.walkEnabled=!0):s||(this.helper.enable("animation",!1),this.helper.enable("ik",!1),this.helper.enable("grant",!1),this.walkEnabled=!1),this.helper.update(e),this.camera.lookAt(this.miku.position)}createRigidBody(e,t,s){var i=new h.btBoxShape(new h.btVector3(e[0],e[1],e[2])),n=new h.btVector3(0,0,0);i.calculateLocalInertia(t,n);var o=new h.btTransform;o.setIdentity(),o.setOrigin(new h.btVector3(s.x,s.y,s.z));var c=new h.btDefaultMotionState(o),d=new h.btRigidBodyConstructionInfo(t,c,i,n);return new h.btRigidBody(d)}createGround(){var e=new F(1e3,500);e.position.y=-15;var t=this.createRigidBody([1e3,1,1e3],0,e.position);t.setRestitution(1),t.setFriction(1),t.setDamping(0,0),t.setSleepingThresholds(0,0),this.scene.add(e)}}const g=window.Ammo;class I extends H{constructor(e){super(e);a(this,"orbitControl");a(this,"character");a(this,"lastTime",-1);this.orbitControl=this.scene.userData.OrbitControls,this.character=this.scene.userData.character}setupLight(){const e=new E(8943462,1);e.position.set(-1,1,1).normalize(),this.scene.add(e),this.scene.add(new T(e.shadow.camera))}initializeScene(){console.log("This is ammo:",g);var e=new g.btBoxShape(new g.btVector3(1,1,1));console.log("This is ammo shape:",e),this.setupLight();const t=new u;t.name="root";const i=new O().getGallery();t.add(i),this.scene.add(t);const n=new B(this.camera,this.glCanvas);this.scene.userData.OrbitControls=n,n.target.set(0,20,0),n.enableKeys=!1,this.scene.userData.character=new G(this.scene,this.camera),this.scene.userData.character.getMiku()}updateScene(e){this.orbitControl.update(),this.lastTime==-1&&(this.lastTime=e);let t=(e-this.lastTime)/1e3;this.character.getMixer()&&this.character.manageMove(t),this.lastTime=e}}function z(){var l=document.getElementById("drawing");if(!l){console.warn("Your HTML page needs a DIV with id='drawing'");return}new I(l)}z();
